<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSV Viewer</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Roboto Mono", monospace;
                background: #fafafa;
                color: #1a1a1a;
                min-height: 100vh;
                padding: 20px;
                font-size: 13px;
            }

            .container {
                max-width: 1800px;
                margin: 0 auto;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding: 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
            }

            .title {
                font-size: 16px;
                font-weight: 500;
                color: #1e40af;
            }

            .view-toggle {
                display: flex;
                gap: 10px;
            }

            .toggle-btn {
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #666;
                cursor: pointer;
                transition: all 0.2s;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border-radius: 20px;
            }

            .toggle-btn:hover {
                background: #dbeafe;
                color: #1e40af;
                border-color: #93c5fd;
            }

            .toggle-btn.active {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                padding: 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                flex-wrap: wrap;
                border-radius: 12px;
            }

            input,
            select {
                padding: 8px 12px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #1a1a1a;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                flex: 1;
                min-width: 150px;
                border-radius: 20px;
            }

            input:focus,
            select:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
            }

            button {
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #1a1a1a;
                cursor: pointer;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                transition: all 0.2s;
                border-radius: 20px;
            }

            button:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            button:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

            .stats {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
            }

            .stat {
                padding: 10px 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                flex: 1;
                border-radius: 12px;
            }

            .stat-label {
                font-size: 10px;
                color: #1e40af;
                text-transform: uppercase;
                margin-bottom: 5px;
            }

            .stat-value {
                font-size: 20px;
                color: #1a1a1a;
            }

            /* Table View */
            .table-view {
                display: block;
            }

            .table-view.hidden {
                display: none;
            }

            .table-container {
                overflow-x: auto;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th {
                padding: 12px;
                background: #dbeafe;
                border-bottom: 1px solid #e0e0e0;
                text-align: left;
                font-weight: 500;
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                position: sticky;
                top: 0;
            }

            td {
                padding: 12px;
                border-bottom: 1px solid #f0f0f0;
                font-size: 12px;
            }

            tbody tr:hover {
                background: #dbeafe;
            }

            /* Last visited row highlighting */
            tbody tr.last-visited {
                background: #fef3c7;
                border-left: 4px solid #f59e0b;
            }

            tbody tr.last-visited:hover {
                background: #fde68a;
            }

            /* Card View */
            .card-view {
                display: none;
            }

            .card-view.active {
                display: block;
            }

            .card-container {
                display: flex;
                gap: 0;
                height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #fafafa;
            }

            .card-nav {
                display: flex;
                flex-direction: column;
                gap: 8px;
                padding: 15px;
                background: #fff;
                border-right: 1px solid #e0e0e0;
                min-width: 280px;
                max-width: 280px;
                overflow-y: auto;
            }

            .card-nav-item {
                padding: 10px 14px;
                background: #fff;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                border-radius: 12px;
            }

            .card-nav-item:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            .card-nav-item.active {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
            }

            .card-content {
                flex: 1;
                background: #fff;
                border: none;
                padding: 40px 60px;
                overflow-y: auto;
            }

            .card {
                max-width: 900px;
                margin: 0 auto;
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #93c5fd;
                flex-wrap: wrap;
                gap: 10px;
            }

            .card-title {
                font-size: 14px;
                font-weight: 500;
                color: #1e40af;
                text-transform: uppercase;
            }

            .card-header-controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .close-card-btn,
            .toggle-sidebar-btn,
            .config-btn {
                padding: 8px 16px;
                background: #fff;
                color: #1a1a1a;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border-radius: 20px;
            }

            .close-card-btn {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .close-card-btn:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            .toggle-sidebar-btn:hover,
            .config-btn:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            .card-nav.hidden {
                display: none;
            }

            .card-content.full-width {
                margin-left: 0;
            }

            /* Config Modal */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: #fff;
                border: 1px solid #e0e0e0;
                padding: 30px;
                max-width: 700px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
                border-radius: 16px;
            }

            .modal-content.wide {
                max-width: 900px;
            }

            .modal-header {
                font-size: 14px;
                font-weight: 500;
                text-transform: uppercase;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #93c5fd;
                color: #1e40af;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                border-bottom: 1px solid #e0e0e0;
                padding-bottom: 10px;
                flex-wrap: wrap;
            }

            .modal-tab {
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                cursor: pointer;
                font-size: 11px;
                text-transform: uppercase;
            }

            .modal-tab:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            .modal-tab.active {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .config-section {
                margin-bottom: 20px;
            }

            .config-section-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 10px;
                font-weight: 500;
            }

            .sidebar-display-select {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                background: #fff;
                cursor: pointer;
            }

            .sidebar-display-select:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
            }

            .field-toggles-container {
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 10px;
            }

            .field-toggle {
                display: flex;
                align-items: center;
                padding: 10px;
                margin-bottom: 5px;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                transition: background 0.2s;
                border-radius: 12px;
            }

            .field-toggle:last-child {
                margin-bottom: 0;
            }

            .field-toggle:hover {
                background: #dbeafe;
                border-color: #93c5fd;
            }

            .field-toggle input[type="checkbox"] {
                margin-right: 10px;
                cursor: pointer;
                accent-color: #1e40af;
                width: 16px;
                height: 16px;
            }

            .field-toggle label {
                flex: 1;
                cursor: pointer;
                font-size: 12px;
            }

            .modal-footer {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
            }

            .modal-footer button:first-child {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .modal-footer button:first-child:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            .card-row.hidden {
                display: none;
            }

            .card-row {
                display: flex;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #f0f0f0;
            }

            .card-label {
                min-width: 200px;
                color: #1e40af;
                font-size: 11px;
                text-transform: uppercase;
            }

            .card-value {
                flex: 1;
                color: #1a1a1a;
                word-break: break-word;
            }

            .card-remarks {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #93c5fd;
            }

            .card-remarks-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 15px;
            }

            .remark-input-wrapper {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
            }

            .remark-input {
                flex: 1;
                padding: 10px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #1a1a1a;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border-radius: 20px;
            }

            .remark-input:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
            }

            .remark-input-wrapper button {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .remark-input-wrapper button:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            .remark-values {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }

            .remark-tag {
                padding: 6px 12px;
                background: #dbeafe;
                border: 1px solid #93c5fd;
                font-size: 11px;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                border-radius: 20px;
                color: #1e40af;
            }

            .remark-meta {
                font-size: 10px;
                color: #999;
                margin-top: 10px;
            }

            .card-navigation {
                display: flex;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #f0f0f0;
                flex-wrap: wrap;
            }

            .message {
                padding: 12px;
                margin-bottom: 20px;
                background: #fff;
                border: 1px solid #e0e0e0;
                font-size: 11px;
                border-radius: 12px;
            }

            .message.success {
                border-color: #4caf50;
                color: #2e7d32;
                background: #e8f5e9;
            }

            .message.error {
                border-color: #f44336;
                color: #c62828;
                background: #ffebee;
            }

            .message.warning {
                border-color: #ff9800;
                color: #e65100;
                background: #fff3e0;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #1e40af;
            }

            .select-all-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .select-all-controls button {
                padding: 6px 12px;
                font-size: 11px;
            }

            .card-nav-header {
                padding: 10px 14px;
                background: #dbeafe;
                border-radius: 12px;
                margin-bottom: 10px;
                font-size: 10px;
                text-transform: uppercase;
                color: #1e40af;
                font-weight: 500;
                text-align: center;
            }

            /* Custom Scripts Styles */
            .scripts-list {
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                max-height: 300px;
                overflow-y: auto;
            }

            .script-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                border-bottom: 1px solid #f0f0f0;
            }

            .script-item:last-child {
                border-bottom: none;
            }

            .script-item-info {
                flex: 1;
            }

            .script-item-name {
                font-weight: 500;
                color: #1e40af;
                font-size: 12px;
            }

            .script-item-meta {
                font-size: 10px;
                color: #666;
                margin-top: 4px;
            }

            .script-item-actions {
                display: flex;
                gap: 8px;
            }

            .script-item-actions button {
                padding: 4px 10px;
                font-size: 10px;
            }

            .add-script-btn {
                margin-top: 10px;
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .add-script-btn:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            /* Script Editor Modal */
            .script-form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }

            .script-form-row {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }

            .script-form-row label {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                font-weight: 500;
            }

            .script-form-row input,
            .script-form-row select {
                flex: none;
                border-radius: 8px;
            }

            .script-form-row textarea {
                width: 100%;
                min-height: 200px;
                padding: 12px;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                resize: vertical;
            }

            .script-form-row textarea:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
            }

            .script-help {
                background: #f8fafc;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                font-size: 11px;
                color: #666;
                margin-bottom: 10px;
            }

            .script-help code {
                background: #e2e8f0;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 10px;
            }

            .script-help-title {
                font-weight: 600;
                color: #1e40af;
                margin-bottom: 8px;
            }

            /* Custom Action Buttons Section */
            .custom-actions-section {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #93c5fd;
            }

            .custom-actions-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 15px;
            }

            .custom-actions-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .custom-action-btn {
                background: #059669;
                color: #fff;
                border-color: #059669;
            }

            .custom-action-btn:hover {
                background: #047857;
                border-color: #047857;
                color: #fff;
            }

            .custom-action-btn.header-btn {
                background: #7c3aed;
                border-color: #7c3aed;
            }

            .custom-action-btn.header-btn:hover {
                background: #6d28d9;
                border-color: #6d28d9;
            }

            .custom-action-btn.navigation-btn {
                background: #ea580c;
                border-color: #ea580c;
            }

            .custom-action-btn.navigation-btn:hover {
                background: #c2410c;
                border-color: #c2410c;
            }

            .no-scripts {
                padding: 20px;
                text-align: center;
                color: #999;
                font-size: 12px;
            }

            /* Pending Windows Modal */
            .pending-windows {
                margin-top: 15px;
            }

            .pending-window-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 12px;
                background: #f8fafc;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 8px;
                font-size: 11px;
            }

            .pending-window-item:last-child {
                margin-bottom: 0;
            }

            .pending-window-url {
                flex: 1;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                margin-right: 10px;
                color: #1e40af;
            }

            .pending-window-item button {
                padding: 4px 12px;
                font-size: 10px;
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .open-all-btn {
                margin-top: 10px;
                background: #059669 !important;
                color: #fff !important;
                border-color: #059669 !important;
                width: 100%;
            }

            .open-all-btn:hover {
                background: #047857 !important;
                border-color: #047857 !important;
            }

            .popup-warning {
                background: #fef3c7;
                border: 1px solid #f59e0b;
                border-radius: 8px;
                padding: 12px;
                margin-bottom: 15px;
                font-size: 11px;
                color: #92400e;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="title">CSV VIEWER</div>
                <div class="view-toggle">
                    <button
                        class="toggle-btn active"
                        onclick="switchView('table')"
                    >
                        TABLE
                    </button>
                    <button class="toggle-btn" onclick="switchView('card')">
                        CARDS
                    </button>
                </div>
            </div>

            <div class="controls">
                <select id="columnFilter">
                    <option value="">FILTER COLUMN</option>
                </select>
                <select id="valueFilter" disabled>
                    <option value="">FILTER VALUE</option>
                </select>
                <input type="text" id="searchInput" placeholder="SEARCH..." />
                <button onclick="applyFilters()">APPLY</button>
                <button onclick="clearFilters()">CLEAR</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="totalRows">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Filtered</div>
                    <div class="stat-value" id="filteredRows">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Current</div>
                    <div class="stat-value" id="currentIndex">-</div>
                </div>
            </div>

            <div id="messageArea"></div>

            <!-- Table View -->
            <div class="table-view" id="tableView">
                <div class="table-container" id="tableContainer">
                    <div class="loading">LOADING...</div>
                </div>
            </div>

            <!-- Card View -->
            <div class="card-view" id="cardView">
                <div class="card-container">
                    <div class="card-nav" id="cardNav"></div>
                    <div class="card-content" id="cardContent">
                        <div class="loading">SELECT A CARD</div>
                    </div>
                </div>
            </div>

            <!-- Config Modal -->
            <div class="modal" id="configModal">
                <div class="modal-content wide">
                    <div class="modal-header">
                        <span>CONFIGURATION</span>
                    </div>

                    <div class="modal-tabs">
                        <button
                            class="modal-tab active"
                            onclick="switchConfigTab('display')"
                        >
                            DISPLAY
                        </button>
                        <button
                            class="modal-tab"
                            onclick="switchConfigTab('fields')"
                        >
                            FIELDS
                        </button>
                        <button
                            class="modal-tab"
                            onclick="switchConfigTab('scripts')"
                        >
                            CUSTOM SCRIPTS
                        </button>
                    </div>

                    <!-- Display Tab -->
                    <div class="tab-content active" id="tab-display">
                        <div class="config-section">
                            <div class="config-section-title">
                                Sidebar Display Column
                            </div>
                            <select
                                id="sidebarDisplayColumn"
                                class="sidebar-display-select"
                            ></select>
                        </div>
                    </div>

                    <!-- Fields Tab -->
                    <div class="tab-content" id="tab-fields">
                        <div class="config-section">
                            <div class="config-section-title">
                                Card Field Visibility
                            </div>
                            <div class="select-all-controls">
                                <button onclick="selectAllFields()">
                                    SELECT ALL
                                </button>
                                <button onclick="deselectAllFields()">
                                    DESELECT ALL
                                </button>
                            </div>
                            <div
                                class="field-toggles-container"
                                id="fieldToggles"
                            ></div>
                        </div>
                    </div>

                    <!-- Scripts Tab -->
                    <div class="tab-content" id="tab-scripts">
                        <div class="config-section">
                            <div class="config-section-title">
                                Custom Action Scripts
                            </div>
                            <div class="script-help">
                                <div class="script-help-title">
                                    Available Variables & Functions:
                                </div>
                                <code>data</code> - Current card data object<br />
                                <code>allData</code> - All filtered data
                                array<br />
                                <code>headers</code> - Column headers array<br />
                                <code>index</code> - Current card index<br /><br />
                                <code>openWindow(url)</code> - Open URL in new
                                tab<br />
                                <code>openWindows([url1, url2, ...])</code> -
                                Open multiple URLs<br />
                                <code>googleSearch(query)</code> - Open Google
                                search<br />
                                <code>copyToClipboard(text)</code> - Copy to
                                clipboard<br />
                                <code>showAlert(msg)</code> - Show message<br />
                                <code>getValue(field)</code> - Get field value
                                safely
                            </div>
                            <div class="scripts-list" id="scriptsList">
                                <div class="no-scripts">
                                    No custom scripts added
                                </div>
                            </div>
                            <button
                                class="add-script-btn"
                                onclick="openScriptEditor()"
                            >
                                + ADD SCRIPT
                            </button>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button onclick="saveFieldConfig()">SAVE</button>
                        <button onclick="closeConfigModal()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Script Editor Modal -->
            <div class="modal" id="scriptEditorModal">
                <div class="modal-content wide">
                    <div class="modal-header">
                        <span id="scriptEditorTitle">ADD CUSTOM SCRIPT</span>
                    </div>

                    <div class="script-form">
                        <div class="script-form-row">
                            <label>Script Name</label>
                            <input
                                type="text"
                                id="scriptName"
                                placeholder="e.g., Doctor Search"
                            />
                        </div>

                        <div class="script-form-row">
                            <label>Button Label</label>
                            <input
                                type="text"
                                id="scriptButtonLabel"
                                placeholder="e.g., Search All"
                            />
                        </div>

                        <div class="script-form-row">
                            <label>Button Position</label>
                            <select id="scriptPosition">
                                <option value="header">
                                    Header (Top Right)
                                </option>
                                <option value="actions">
                                    Custom Actions Section
                                </option>
                                <option value="navigation">
                                    Navigation Area
                                </option>
                            </select>
                        </div>

                        <div class="script-form-row">
                            <label>JavaScript Code</label>
                            <textarea
                                id="scriptCode"
                                placeholder="// Your code here..."
                            ></textarea>
                        </div>

                        <div class="script-help">
                            <div class="script-help-title">
                                Example: Your Doctor Search Script
                            </div>
                            <pre
                                style="
                                    background: #e2e8f0;
                                    padding: 10px;
                                    border-radius: 6px;
                                    overflow-x: auto;
                                    font-size: 10px;
                                "
                            >
const name = getValue('Keyword');
const spec = getValue('Speciality Name');
const city = getValue('City');

const query1 = `dr ${name}`;
const query2 = `${query1} ${spec} ${city}`;
const query3 = `${query2} hexaheath`;

copyToClipboard(name);

// Opens all 3 searches (handles popup blockers)
openWindows([
    googleSearch(query1),
    googleSearch(query2),
    googleSearch(query3)
]);</pre
                            >
                        </div>

                        <div class="script-help">
                            <div class="script-help-title">More Examples:</div>
                            <strong>1. Simple Google Search:</strong><br />
                            <code>googleSearch(getValue('Name'));</code
                            ><br /><br />
                            <strong>2. Open Website from data:</strong><br />
                            <code>openWindow(getValue('Website'));</code
                            ><br /><br />
                            <strong>3. Copy & Search:</strong><br />
                            <code
                                >copyToClipboard(getValue('Email'));
                                showAlert('Copied!');</code
                            ><br /><br />
                            <strong>4. LinkedIn Search:</strong><br />
                            <code
                                >openWindow('https://linkedin.com/search/results/all/?keywords='
                                +
                                encodeURIComponent(getValue('Company')));</code
                            >
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button onclick="saveScript()">SAVE SCRIPT</button>
                        <button onclick="closeScriptEditor()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Pending Windows Modal -->
            <div class="modal" id="pendingWindowsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <span>OPEN WINDOWS</span>
                    </div>

                    <div class="popup-warning">
                        ⚠️ <strong>Popup Blocker Detected!</strong><br />
                        Your browser blocked some windows. Click each button to
                        open, or allow popups for this site.
                    </div>

                    <div class="pending-windows" id="pendingWindowsList"></div>

                    <button
                        class="open-all-btn"
                        onclick="openAllPendingWindows()"
                    >
                        OPEN ALL WINDOWS
                    </button>

                    <div class="modal-footer">
                        <button onclick="closePendingWindowsModal()">
                            CLOSE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let allData = [];
            let filteredData = [];
            let headers = [];
            let remarkColumns = [];
            let filterOptions = {};
            let currentView = "table";
            let currentCardIndex = -1;
            let currentFilePath = "";
            let sidebarVisible = true;
            let visibleFields = {};
            let sidebarDisplayColumn = "";
            let customScripts = [];
            let editingScriptIndex = -1;
            let pendingWindows = [];

            // Cookie helper functions
            function setCookie(name, value, days = 365) {
                const expires = new Date();
                expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
                document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
            }

            function getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(";");
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === " ") c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0)
                        return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            function getFileHash() {
                let hash = 0;
                const str = currentFilePath || window.location.pathname;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = (hash << 5) - hash + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(36);
            }

            function saveLastVisited(index) {
                const fileHash = getFileHash();
                setCookie(`last_visited_${fileHash}`, index);
            }

            function getLastVisited() {
                const fileHash = getFileHash();
                const lastVisited = getCookie(`last_visited_${fileHash}`);
                return lastVisited ? parseInt(lastVisited) : -1;
            }

            function saveSidebarState(visible) {
                const fileHash = getFileHash();
                setCookie(`sidebar_${fileHash}`, visible ? "1" : "0");
            }

            function getSidebarState() {
                const fileHash = getFileHash();
                const state = getCookie(`sidebar_${fileHash}`);
                return state === null ? true : state === "1";
            }

            function saveFieldVisibility(fields) {
                const fileHash = getFileHash();
                setCookie(`fields_${fileHash}`, JSON.stringify(fields));
            }

            function getFieldVisibility() {
                const fileHash = getFileHash();
                const fields = getCookie(`fields_${fileHash}`);
                return fields ? JSON.parse(fields) : {};
            }

            function saveSidebarDisplayColumn(column) {
                const fileHash = getFileHash();
                setCookie(`sidebar_col_${fileHash}`, column);
            }

            function getSidebarDisplayColumn() {
                const fileHash = getFileHash();
                return getCookie(`sidebar_col_${fileHash}`) || "";
            }

            function saveCustomScripts(scripts) {
                const fileHash = getFileHash();
                localStorage.setItem(
                    `scripts_${fileHash}`,
                    JSON.stringify(scripts),
                );
            }

            function getCustomScripts() {
                const fileHash = getFileHash();
                const scripts = localStorage.getItem(`scripts_${fileHash}`);
                return scripts ? JSON.parse(scripts) : [];
            }

            function initializeFieldVisibility() {
                visibleFields = getFieldVisibility();
                if (Object.keys(visibleFields).length === 0) {
                    headers.forEach((header) => {
                        visibleFields[header] = true;
                    });
                }
            }

            function initializeSidebarDisplayColumn() {
                const saved = getSidebarDisplayColumn();
                if (saved && headers.includes(saved)) {
                    sidebarDisplayColumn = saved;
                } else if (headers.length > 0) {
                    sidebarDisplayColumn = headers[0];
                }
            }

            function initializeCustomScripts() {
                customScripts = getCustomScripts();
            }

            async function init() {
                await loadHeaders();
                await loadFilterOptions();
                await loadData();

                initializeFieldVisibility();
                initializeSidebarDisplayColumn();
                initializeCustomScripts();
                sidebarVisible = getSidebarState();

                const lastVisited = getLastVisited();
                if (
                    lastVisited >= 0 &&
                    filteredData.length > 0 &&
                    lastVisited < filteredData.length
                ) {
                    currentCardIndex = lastVisited;
                }
            }

            async function loadHeaders() {
                try {
                    const response = await fetch("/api/headers");
                    const data = await response.json();
                    headers = data.headers;
                    remarkColumns = data.remark_columns || [];
                    populateColumnFilter();
                } catch (error) {
                    showMessage("ERROR LOADING HEADERS", "error");
                }
            }

            async function loadFilterOptions() {
                try {
                    const response = await fetch("/api/filter-options");
                    filterOptions = await response.json();
                } catch (error) {
                    console.error(error);
                }
            }

            function populateColumnFilter() {
                const columnFilter = document.getElementById("columnFilter");
                columnFilter.innerHTML =
                    '<option value="">FILTER COLUMN</option>';
                headers.forEach((header) => {
                    const option = document.createElement("option");
                    option.value = header;
                    option.textContent = header.toUpperCase();
                    columnFilter.appendChild(option);
                });

                columnFilter.addEventListener("change", function () {
                    const valueFilter = document.getElementById("valueFilter");
                    valueFilter.innerHTML =
                        '<option value="">FILTER VALUE</option>';

                    if (this.value) {
                        valueFilter.disabled = false;
                        const values = filterOptions[this.value] || [];
                        values.forEach((value) => {
                            const option = document.createElement("option");
                            option.value = value;
                            option.textContent = value.toUpperCase();
                            valueFilter.appendChild(option);
                        });
                    } else {
                        valueFilter.disabled = true;
                    }
                });
            }

            async function loadData(filters = {}) {
                try {
                    let url = "/api/data";
                    const params = new URLSearchParams();

                    if (filters.column) params.append("column", filters.column);
                    if (filters.value) params.append("value", filters.value);
                    if (filters.search) params.append("search", filters.search);

                    if (params.toString()) url += "?" + params.toString();

                    const response = await fetch(url);
                    const result = await response.json();

                    filteredData = result.data || [];
                    remarkColumns = result.remark_columns || [];

                    if (currentView === "table") {
                        renderTable(filteredData);
                    } else {
                        renderCards(filteredData);
                        if (
                            currentCardIndex >= 0 &&
                            currentCardIndex < filteredData.length
                        ) {
                            showCard(currentCardIndex);
                        }
                    }

                    updateStats(result.total || 0);
                } catch (error) {
                    showMessage("ERROR LOADING DATA", "error");
                }
            }

            function renderTable(data) {
                const container = document.getElementById("tableContainer");
                const lastVisited = getLastVisited();

                if (data.length === 0) {
                    container.innerHTML = '<div class="loading">NO DATA</div>';
                    return;
                }

                let html = "<table><thead><tr>";

                headers.forEach((header) => {
                    html += `<th>${header.toUpperCase()}</th>`;
                });

                remarkColumns.forEach((col) => {
                    html += `<th>${col.toUpperCase()}</th>`;
                });

                html += "<th>ACTIONS</th></tr></thead><tbody>";

                data.forEach((row, idx) => {
                    const isLastVisited = idx === lastVisited;
                    html += `<tr class="${isLastVisited ? "last-visited" : ""}" id="table-row-${idx}">`;
                    headers.forEach((header) => {
                        html += `<td>${row[header] || ""}</td>`;
                    });

                    remarkColumns.forEach((col) => {
                        html += `<td>${row[col] || ""}</td>`;
                    });

                    html += `<td><button onclick="openCardFromTable(${idx})">CARD</button></td>`;
                    html += "</tr>";
                });

                html += "</tbody></table>";
                container.innerHTML = html;

                // Scroll to last visited row
                if (lastVisited >= 0) {
                    const lastVisitedRow = document.getElementById(
                        `table-row-${lastVisited}`,
                    );
                    if (lastVisitedRow) {
                        setTimeout(() => {
                            lastVisitedRow.scrollIntoView({
                                behavior: "smooth",
                                block: "center",
                            });
                        }, 100);
                    }
                }
            }

            function renderCards(data) {
                const nav = document.getElementById("cardNav");
                nav.innerHTML = "";

                const headerDiv = document.createElement("div");
                headerDiv.className = "card-nav-header";
                headerDiv.id = "cardNavHeader";
                headerDiv.textContent = `Showing: ${sidebarDisplayColumn || headers[0] || "Items"}`;
                nav.appendChild(headerDiv);

                const displayColumn = sidebarDisplayColumn || headers[0] || "";

                data.forEach((row, idx) => {
                    const item = document.createElement("div");
                    item.className = "card-nav-item";
                    item.id = `card-nav-item-${idx}`;
                    const displayValue =
                        row[displayColumn] || "ROW " + (idx + 1);
                    item.textContent = `${idx + 1}. ${displayValue}`;
                    item.onclick = () => showCard(idx);

                    if (idx === currentCardIndex) {
                        item.classList.add("active");
                    }

                    nav.appendChild(item);
                });
            }

            function showCard(index) {
                currentCardIndex = index;
                const row = filteredData[index];
                const content = document.getElementById("cardContent");

                saveLastVisited(index);

                document
                    .querySelectorAll(".card-nav-item")
                    .forEach((item, idx) => {
                        item.classList.toggle("active", idx === index);
                    });

                const activeItem = document.getElementById(
                    `card-nav-item-${index}`,
                );
                if (activeItem) {
                    activeItem.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest",
                        inline: "nearest",
                    });
                }

                // Get header scripts
                const headerScripts = customScripts.filter(
                    (s) => s.position === "header",
                );

                let html = '<div class="card">';

                html += `
                <div class="card-header">
                    <div class="card-title">CARD ${index + 1} OF ${filteredData.length}</div>
                    <div class="card-header-controls">
                        ${headerScripts
                            .map(
                                (script, i) => `
                            <button class="custom-action-btn header-btn" onclick="executeScript(${customScripts.indexOf(script)})">
                                ${script.buttonLabel}
                            </button>
                        `,
                            )
                            .join("")}
                        <button class="toggle-sidebar-btn" onclick="toggleSidebar()">
                            ${sidebarVisible ? "HIDE" : "SHOW"} SIDEBAR
                        </button>
                        <button class="config-btn" onclick="openConfigModal()">CONFIG</button>
                        <button class="close-card-btn" onclick="closeCardView()">CLOSE</button>
                    </div>
                </div>
            `;

                headers.forEach((header) => {
                    const isVisible = visibleFields[header] !== false;
                    html += `
                    <div class="card-row ${isVisible ? "" : "hidden"}" data-field="${header}">
                        <div class="card-label">${header}</div>
                        <div class="card-value">${row[header] || "-"}</div>
                    </div>
                `;
                });

                // Custom Actions Section
                const actionScripts = customScripts.filter(
                    (s) => s.position === "actions",
                );
                if (actionScripts.length > 0) {
                    html += `
                    <div class="custom-actions-section">
                        <div class="custom-actions-title">CUSTOM ACTIONS</div>
                        <div class="custom-actions-buttons">
                            ${actionScripts
                                .map(
                                    (script, i) => `
                                <button class="custom-action-btn" onclick="executeScript(${customScripts.indexOf(script)})">
                                    ${script.buttonLabel}
                                </button>
                            `,
                                )
                                .join("")}
                        </div>
                    </div>
                `;
                }

                html += `
                <div class="card-remarks">
                    <div class="card-remarks-title">REMARKS</div>
                    <div class="remark-input-wrapper">
                        <input type="text" class="remark-input" id="cardRemarkInput"
                               placeholder="value1, value2, value3...">
                        <button onclick="saveCardRemark()">SAVE</button>
                    </div>
            `;

                if (remarkColumns.length > 0) {
                    html += '<div class="remark-values">';
                    remarkColumns.forEach((col) => {
                        const value = row[col] || "";
                        if (value) {
                            html += `
                            <div class="remark-tag">
                                ${col}: ${value}
                            </div>
                        `;
                        }
                    });
                    html += "</div>";

                    if (row._timestamp) {
                        html += `<div class="remark-meta">LAST MODIFIED: ${row._timestamp}</div>`;
                    }
                }

                html += `</div>`;

                // Navigation with custom scripts
                const navScripts = customScripts.filter(
                    (s) => s.position === "navigation",
                );
                html += `
                <div class="card-navigation">
                    <button onclick="navigateCard(-1)" ${index === 0 ? "disabled" : ""}>← PREV</button>
                    <button onclick="navigateCard(1)" ${index === filteredData.length - 1 ? "disabled" : ""}>NEXT →</button>
                    ${navScripts
                        .map(
                            (script, i) => `
                        <button class="custom-action-btn navigation-btn" onclick="executeScript(${customScripts.indexOf(script)})">
                            ${script.buttonLabel}
                        </button>
                    `,
                        )
                        .join("")}
                </div>
            `;

                html += "</div>";
                content.innerHTML = html;

                document.getElementById("currentIndex").textContent = index + 1;

                applySidebarState();
            }

            // ============ SCRIPT HELPER FUNCTIONS ============

            // Get value from current card data safely
            function getValue(field) {
                const data = filteredData[currentCardIndex];
                return data ? data[field] || "" : "";
            }

            // Open single window
            function openWindow(url) {
                if (!url) {
                    showMessage("No URL provided", "error");
                    return null;
                }
                const win = window.open(url, "_blank");
                if (!win) {
                    pendingWindows.push(url);
                    return null;
                }
                return win;
            }

            // Generate Google search URL
            function googleSearch(query) {
                return (
                    "https://www.google.com/search?q=" +
                    encodeURIComponent(query)
                );
            }

            // Open multiple windows with popup blocker handling
            function openWindows(urls) {
                pendingWindows = [];
                let blockedCount = 0;

                urls.forEach((url, index) => {
                    if (!url) return;

                    // Try to open with a small delay
                    setTimeout(() => {
                        const win = window.open(url, "_blank");
                        if (!win) {
                            pendingWindows.push(url);
                            blockedCount++;

                            // Show modal if this is the last one and some were blocked
                            if (
                                index === urls.length - 1 &&
                                pendingWindows.length > 0
                            ) {
                                setTimeout(
                                    () => showPendingWindowsModal(),
                                    100,
                                );
                            }
                        }
                    }, index * 100);
                });

                // Check after all attempts
                setTimeout(
                    () => {
                        if (pendingWindows.length > 0) {
                            showPendingWindowsModal();
                        }
                    },
                    urls.length * 100 + 200,
                );
            }

            // Show alert message
            function showAlert(message) {
                showMessage(message, "success");
            }

            // Copy to clipboard
            function copyToClipboard(text) {
                if (!text) {
                    showMessage("Nothing to copy", "error");
                    return;
                }
                navigator.clipboard
                    .writeText(text)
                    .then(() => {
                        showMessage(
                            "Copied: " +
                                text.substring(0, 50) +
                                (text.length > 50 ? "..." : ""),
                            "success",
                        );
                    })
                    .catch((err) => {
                        showMessage("Failed to copy", "error");
                    });
            }

            // Show pending windows modal
            function showPendingWindowsModal() {
                const modal = document.getElementById("pendingWindowsModal");
                const list = document.getElementById("pendingWindowsList");

                list.innerHTML = pendingWindows
                    .map(
                        (url, index) => `
                    <div class="pending-window-item">
                        <span class="pending-window-url" title="${url}">${url}</span>
                        <button onclick="openSinglePendingWindow(${index})">OPEN</button>
                    </div>
                `,
                    )
                    .join("");

                modal.classList.add("active");
            }

            function openSinglePendingWindow(index) {
                const url = pendingWindows[index];
                window.open(url, "_blank");

                // Remove from list
                const items = document.querySelectorAll(".pending-window-item");
                if (items[index]) {
                    items[index].style.opacity = "0.5";
                    items[index].querySelector("button").disabled = true;
                    items[index].querySelector("button").textContent = "OPENED";
                }
            }

            function openAllPendingWindows() {
                pendingWindows.forEach((url, index) => {
                    setTimeout(() => {
                        window.open(url, "_blank");
                    }, index * 300);
                });

                setTimeout(
                    () => {
                        closePendingWindowsModal();
                        showMessage("Opened all windows!", "success");
                    },
                    pendingWindows.length * 300 + 100,
                );
            }

            function closePendingWindowsModal() {
                document
                    .getElementById("pendingWindowsModal")
                    .classList.remove("active");
                pendingWindows = [];
            }

            // Execute custom script
            function executeScript(scriptIndex) {
                const script = customScripts[scriptIndex];
                if (!script) return;

                const data = filteredData[currentCardIndex];
                const index = currentCardIndex;
                const allDataRef = filteredData;

                try {
                    // Create function with all helpers available
                    const fn = new Function(
                        "data",
                        "allData",
                        "headers",
                        "index",
                        "openWindow",
                        "openWindows",
                        "googleSearch",
                        "showAlert",
                        "copyToClipboard",
                        "getValue",
                        script.code,
                    );
                    fn(
                        data,
                        allDataRef,
                        headers,
                        index,
                        openWindow,
                        openWindows,
                        googleSearch,
                        showAlert,
                        copyToClipboard,
                        getValue,
                    );
                } catch (error) {
                    showMessage("Script error: " + error.message, "error");
                    console.error("Script execution error:", error);
                }
            }

            async function saveCardRemark() {
                const input = document.getElementById("cardRemarkInput");
                const remark = input.value.trim();

                if (!remark) {
                    showMessage("ENTER REMARK VALUES", "error");
                    return;
                }

                const row = filteredData[currentCardIndex];
                const rowIndex = row._index;

                try {
                    const response = await fetch(`/api/remarks/${rowIndex}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ remark }),
                    });

                    const result = await response.json();

                    if (result.success) {
                        showMessage("SAVED", "success");
                        input.value = "";
                        await loadData();
                    } else {
                        showMessage("SAVE FAILED", "error");
                    }
                } catch (error) {
                    showMessage("ERROR: " + error.message, "error");
                }
            }

            function navigateCard(direction) {
                const newIndex = currentCardIndex + direction;
                if (newIndex >= 0 && newIndex < filteredData.length) {
                    showCard(newIndex);
                }
            }

            function openCardFromTable(index) {
                currentCardIndex = index;
                switchView("card");
                showCard(index);
            }

            function closeCardView() {
                switchView("table");
            }

            function toggleSidebar() {
                sidebarVisible = !sidebarVisible;
                saveSidebarState(sidebarVisible);
                applySidebarState();

                const btn = document.querySelector(".toggle-sidebar-btn");
                if (btn) {
                    btn.textContent = sidebarVisible
                        ? "HIDE SIDEBAR"
                        : "SHOW SIDEBAR";
                }
            }

            function applySidebarState() {
                const nav = document.getElementById("cardNav");
                const content = document.getElementById("cardContent");

                if (sidebarVisible) {
                    nav.classList.remove("hidden");
                    content.classList.remove("full-width");
                } else {
                    nav.classList.add("hidden");
                    content.classList.add("full-width");
                }
            }

            function switchConfigTab(tabName) {
                document.querySelectorAll(".modal-tab").forEach((tab) => {
                    tab.classList.remove("active");
                });
                document.querySelectorAll(".tab-content").forEach((content) => {
                    content.classList.remove("active");
                });

                event.target.classList.add("active");
                document
                    .getElementById(`tab-${tabName}`)
                    .classList.add("active");
            }

            function openConfigModal() {
                const modal = document.getElementById("configModal");

                // Reset to first tab
                document.querySelectorAll(".modal-tab").forEach((tab, i) => {
                    tab.classList.toggle("active", i === 0);
                });
                document
                    .querySelectorAll(".tab-content")
                    .forEach((content, i) => {
                        content.classList.toggle("active", i === 0);
                    });

                const sidebarSelect = document.getElementById(
                    "sidebarDisplayColumn",
                );
                sidebarSelect.innerHTML = "";

                headers.forEach((header) => {
                    const option = document.createElement("option");
                    option.value = header;
                    option.textContent = header.toUpperCase();
                    if (header === sidebarDisplayColumn) {
                        option.selected = true;
                    }
                    sidebarSelect.appendChild(option);
                });

                const togglesContainer =
                    document.getElementById("fieldToggles");
                togglesContainer.innerHTML = "";

                headers.forEach((header) => {
                    const isChecked = visibleFields[header] !== false;
                    const div = document.createElement("div");
                    div.className = "field-toggle";
                    div.innerHTML = `
                    <input type="checkbox" id="field_${header}" ${isChecked ? "checked" : ""}>
                    <label for="field_${header}">${header}</label>
                `;
                    togglesContainer.appendChild(div);

                    div.onclick = function (e) {
                        if (e.target.tagName !== "INPUT") {
                            const checkbox = div.querySelector("input");
                            checkbox.checked = !checkbox.checked;
                        }
                    };
                });

                // Render scripts list
                renderScriptsList();

                modal.classList.add("active");
            }

            function renderScriptsList() {
                const container = document.getElementById("scriptsList");

                if (customScripts.length === 0) {
                    container.innerHTML =
                        '<div class="no-scripts">No custom scripts added</div>';
                    return;
                }

                container.innerHTML = customScripts
                    .map(
                        (script, index) => `
                    <div class="script-item">
                        <div class="script-item-info">
                            <div class="script-item-name">${script.name}</div>
                            <div class="script-item-meta">Button: "${script.buttonLabel}" | Position: ${script.position}</div>
                        </div>
                        <div class="script-item-actions">
                            <button onclick="editScript(${index})">EDIT</button>
                            <button onclick="deleteScript(${index})">DELETE</button>
                        </div>
                    </div>
                `,
                    )
                    .join("");
            }

            function openScriptEditor(index = -1) {
                editingScriptIndex = index;
                const modal = document.getElementById("scriptEditorModal");
                const title = document.getElementById("scriptEditorTitle");

                if (index >= 0) {
                    const script = customScripts[index];
                    title.textContent = "EDIT SCRIPT";
                    document.getElementById("scriptName").value = script.name;
                    document.getElementById("scriptButtonLabel").value =
                        script.buttonLabel;
                    document.getElementById("scriptPosition").value =
                        script.position;
                    document.getElementById("scriptCode").value = script.code;
                } else {
                    title.textContent = "ADD CUSTOM SCRIPT";
                    document.getElementById("scriptName").value = "";
                    document.getElementById("scriptButtonLabel").value = "";
                    document.getElementById("scriptPosition").value = "actions";
                    document.getElementById("scriptCode").value = "";
                }

                modal.classList.add("active");
            }

            function closeScriptEditor() {
                document
                    .getElementById("scriptEditorModal")
                    .classList.remove("active");
                editingScriptIndex = -1;
            }

            function saveScript() {
                const name = document.getElementById("scriptName").value.trim();
                const buttonLabel = document
                    .getElementById("scriptButtonLabel")
                    .value.trim();
                const position =
                    document.getElementById("scriptPosition").value;
                const code = document.getElementById("scriptCode").value.trim();

                if (!name || !buttonLabel || !code) {
                    showMessage("Please fill all fields", "error");
                    return;
                }

                const script = { name, buttonLabel, position, code };

                if (editingScriptIndex >= 0) {
                    customScripts[editingScriptIndex] = script;
                } else {
                    customScripts.push(script);
                }

                saveCustomScripts(customScripts);
                renderScriptsList();
                closeScriptEditor();
                showMessage("Script saved!", "success");
            }

            function editScript(index) {
                openScriptEditor(index);
            }

            function deleteScript(index) {
                if (confirm("Are you sure you want to delete this script?")) {
                    customScripts.splice(index, 1);
                    saveCustomScripts(customScripts);
                    renderScriptsList();
                    showMessage("Script deleted", "success");
                }
            }

            function selectAllFields() {
                headers.forEach((header) => {
                    const checkbox = document.getElementById(`field_${header}`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            function deselectAllFields() {
                headers.forEach((header) => {
                    const checkbox = document.getElementById(`field_${header}`);
                    if (checkbox) checkbox.checked = false;
                });
            }

            function closeConfigModal() {
                const modal = document.getElementById("configModal");
                modal.classList.remove("active");
            }

            function saveFieldConfig() {
                const sidebarSelect = document.getElementById(
                    "sidebarDisplayColumn",
                );
                sidebarDisplayColumn = sidebarSelect.value;
                saveSidebarDisplayColumn(sidebarDisplayColumn);

                headers.forEach((header) => {
                    const checkbox = document.getElementById(`field_${header}`);
                    visibleFields[header] = checkbox.checked;
                });

                saveFieldVisibility(visibleFields);
                closeConfigModal();

                renderCards(filteredData);

                if (currentCardIndex >= 0) {
                    showCard(currentCardIndex);
                }

                if (currentView === "table") {
                    renderTable(filteredData);
                }
            }

            function switchView(view) {
                currentView = view;

                document.querySelectorAll(".toggle-btn").forEach((btn) => {
                    btn.classList.remove("active");
                });

                if (view === "table") {
                    document
                        .getElementById("tableView")
                        .classList.remove("hidden");
                    document
                        .getElementById("cardView")
                        .classList.remove("active");
                    document
                        .querySelectorAll(".toggle-btn")[0]
                        .classList.add("active");
                    document.getElementById("currentIndex").textContent = "-";

                    renderTable(filteredData);
                } else {
                    document
                        .getElementById("tableView")
                        .classList.add("hidden");
                    document.getElementById("cardView").classList.add("active");
                    document
                        .querySelectorAll(".toggle-btn")[1]
                        .classList.add("active");
                    renderCards(filteredData);

                    const lastVisited = getLastVisited();
                    if (lastVisited >= 0 && lastVisited < filteredData.length) {
                        showCard(lastVisited);
                    } else if (
                        currentCardIndex >= 0 &&
                        currentCardIndex < filteredData.length
                    ) {
                        showCard(currentCardIndex);
                    } else if (filteredData.length > 0) {
                        showCard(0);
                    }
                }
            }

            function applyFilters() {
                const column = document.getElementById("columnFilter").value;
                const value = document.getElementById("valueFilter").value;
                const search = document.getElementById("searchInput").value;

                const filters = {};
                if (column) filters.column = column;
                if (value) filters.value = value;
                if (search) filters.search = search;

                loadData(filters);
            }

            function clearFilters() {
                document.getElementById("columnFilter").value = "";
                document.getElementById("valueFilter").value = "";
                document.getElementById("valueFilter").disabled = true;
                document.getElementById("searchInput").value = "";
                loadData();
            }

            function updateStats(filteredCount) {
                document.getElementById("filteredRows").textContent =
                    filteredCount;
            }

            function showMessage(message, type) {
                const messageArea = document.getElementById("messageArea");
                const div = document.createElement("div");
                div.className = `message ${type}`;
                div.textContent = message;
                messageArea.innerHTML = "";
                messageArea.appendChild(div);

                setTimeout(() => {
                    messageArea.innerHTML = "";
                }, 3000);
            }

            document.addEventListener("DOMContentLoaded", function () {
                document
                    .getElementById("searchInput")
                    .addEventListener("keypress", function (e) {
                        if (e.key === "Enter") applyFilters();
                    });

                document.addEventListener("keydown", function (e) {
                    if (e.key === "Escape") {
                        const pendingModal = document.getElementById(
                            "pendingWindowsModal",
                        );
                        const scriptModal =
                            document.getElementById("scriptEditorModal");
                        const configModal =
                            document.getElementById("configModal");

                        if (pendingModal.classList.contains("active")) {
                            closePendingWindowsModal();
                        } else if (scriptModal.classList.contains("active")) {
                            closeScriptEditor();
                        } else if (configModal.classList.contains("active")) {
                            closeConfigModal();
                        } else if (currentView === "card") {
                            closeCardView();
                        }
                    }
                });

                document.addEventListener("keydown", function (e) {
                    if (
                        currentView === "card" &&
                        !document
                            .getElementById("configModal")
                            .classList.contains("active") &&
                        !document
                            .getElementById("scriptEditorModal")
                            .classList.contains("active") &&
                        !document
                            .getElementById("pendingWindowsModal")
                            .classList.contains("active")
                    ) {
                        if (e.key === "ArrowLeft" && currentCardIndex > 0) {
                            navigateCard(-1);
                        } else if (
                            e.key === "ArrowRight" &&
                            currentCardIndex < filteredData.length - 1
                        ) {
                            navigateCard(1);
                        }
                    }
                });

                fetch("/api/data")
                    .then((r) => r.json())
                    .then((result) => {
                        document.getElementById("totalRows").textContent =
                            result.total || 0;
                    });

                init();
            });
        </script>
    </body>
</html>
