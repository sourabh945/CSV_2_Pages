<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CSV Viewer</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Roboto Mono", monospace;
                background: #fafafa;
                color: #1a1a1a;
                min-height: 100vh;
                padding: 20px;
                font-size: 13px;
            }

            .container {
                max-width: 1800px;
                margin: 0 auto;
            }

            .header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding: 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
            }

            .title {
                font-size: 16px;
                font-weight: 500;
                color: #1e40af;
            }

            .header-controls {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .view-toggle {
                display: flex;
                gap: 10px;
            }

            .toggle-btn {
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #666;
                cursor: pointer;
                transition: all 0.2s;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border-radius: 20px;
            }

            .toggle-btn:hover {
                background: #dbeafe;
                color: #1e40af;
                border-color: #93c5fd;
            }

            .toggle-btn.active {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                padding: 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                flex-wrap: wrap;
                border-radius: 12px;
            }

            input,
            select {
                padding: 8px 12px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #1a1a1a;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                flex: 1;
                min-width: 150px;
                border-radius: 20px;
            }

            input:focus,
            select:focus {
                outline: none;
                border-color: #1e40af;
                box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.15);
            }

            button {
                padding: 8px 16px;
                background: #fff;
                border: 1px solid #e0e0e0;
                color: #1a1a1a;
                cursor: pointer;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                transition: all 0.2s;
                border-radius: 20px;
            }

            button:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            button:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

            .stats {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .stat {
                padding: 10px 15px;
                background: #fff;
                border: 1px solid #e0e0e0;
                flex: 1;
                min-width: 120px;
                border-radius: 12px;
            }

            .stat-label {
                font-size: 10px;
                color: #1e40af;
                text-transform: uppercase;
                margin-bottom: 5px;
            }

            .stat-value {
                font-size: 20px;
                color: #1a1a1a;
            }

            /* Analytics Panel */
            .analytics-panel {
                display: none;
                margin-bottom: 20px;
                padding: 20px;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
            }

            .analytics-panel.active {
                display: block;
            }

            .analytics-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 2px solid #93c5fd;
            }

            .analytics-title {
                font-size: 14px;
                font-weight: 500;
                color: #1e40af;
                text-transform: uppercase;
            }

            .analytics-results {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 15px;
            }

            .analytics-result-card {
                padding: 15px;
                background: #f8fafc;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
            }

            .analytics-result-label {
                font-size: 10px;
                color: #666;
                text-transform: uppercase;
                margin-bottom: 5px;
            }

            .analytics-result-value {
                font-size: 18px;
                color: #1e40af;
                font-weight: 500;
                word-break: break-word;
            }

            .table-scripts-container {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 1px solid #e0e0e0;
            }

            .table-script-btn {
                background: #7c3aed;
                color: #fff;
                border-color: #7c3aed;
            }

            .table-script-btn:hover {
                background: #6d28d9;
                border-color: #6d28d9;
                color: #fff;
            }

            /* Table View */
            .table-view {
                display: block;
            }

            .table-view.hidden {
                display: none;
            }

            .table-container {
                overflow-x: auto;
                background: #fff;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
            }

            th {
                padding: 12px;
                background: #dbeafe;
                border-bottom: 1px solid #e0e0e0;
                text-align: left;
                font-weight: 500;
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                position: sticky;
                top: 0;
            }

            th.hidden-column,
            td.hidden-column {
                display: none;
            }

            td {
                padding: 12px;
                border-bottom: 1px solid #f0f0f0;
                font-size: 12px;
            }

            tbody tr:hover {
                background: #dbeafe;
            }

            tbody tr.last-visited {
                background: #fef3c7;
                border-left: 4px solid #f59e0b;
            }

            tbody tr.last-visited:hover {
                background: #fde68a;
            }

            /* Card View */
            .card-view {
                display: none;
            }

            .card-view.active {
                display: block;
            }

            .card-container {
                display: flex;
                gap: 0;
                height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: #fafafa;
            }

            .card-nav {
                display: flex;
                flex-direction: column;
                gap: 8px;
                padding: 15px;
                background: #fff;
                border-right: 1px solid #e0e0e0;
                min-width: 280px;
                max-width: 280px;
                overflow-y: auto;
            }

            .card-nav-item {
                padding: 10px 14px;
                background: #fff;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                transition: all 0.2s;
                font-size: 11px;
                border-radius: 12px;
            }

            .card-nav-item:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            .card-nav-item.active {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
                font-weight: 500;
                box-shadow: 0 2px 8px rgba(30, 64, 175, 0.3);
            }

            .card-content {
                flex: 1;
                background: #fff;
                border: none;
                padding: 40px 60px;
                overflow-y: auto;
            }

            .card {
                max-width: 900px;
                margin: 0 auto;
            }

            .card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #93c5fd;
                flex-wrap: wrap;
                gap: 10px;
            }

            .card-title {
                font-size: 14px;
                font-weight: 500;
                color: #1e40af;
                text-transform: uppercase;
            }

            .card-header-controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .close-card-btn,
            .toggle-sidebar-btn,
            .config-btn {
                padding: 8px 16px;
                background: #fff;
                color: #1a1a1a;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border-radius: 20px;
            }

            .close-card-btn {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .close-card-btn:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            .toggle-sidebar-btn:hover,
            .config-btn:hover {
                background: #dbeafe;
                border-color: #93c5fd;
                color: #1e40af;
            }

            .card-nav.hidden {
                display: none;
            }

            .card-content.full-width {
                margin-left: 0;
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .modal.active {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modal-content {
                background: #fff;
                border: 1px solid #e0e0e0;
                padding: 30px;
                max-width: 600px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
                border-radius: 16px;
            }

            .modal-content.wide {
                max-width: 800px;
            }

            .modal-header {
                font-size: 14px;
                font-weight: 500;
                text-transform: uppercase;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #93c5fd;
                color: #1e40af;
            }

            .modal-footer {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
            }

            .modal-footer button.primary {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .modal-footer button.primary:hover {
                background: #1e3a8a;
                border-color: #1e3a8a;
            }

            .config-section {
                margin-bottom: 20px;
            }

            .config-section-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 10px;
                font-weight: 500;
            }

            .field-toggles-container {
                max-height: 250px;
                overflow-y: auto;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 10px;
            }

            .field-toggle {
                display: flex;
                align-items: center;
                padding: 8px 10px;
                margin-bottom: 4px;
                border: 1px solid #e0e0e0;
                cursor: pointer;
                transition: background 0.2s;
                border-radius: 8px;
            }

            .field-toggle:hover {
                background: #dbeafe;
                border-color: #93c5fd;
            }

            .field-toggle input[type="checkbox"] {
                margin-right: 10px;
                cursor: pointer;
                accent-color: #1e40af;
                width: 16px;
                height: 16px;
            }

            .field-toggle label {
                flex: 1;
                cursor: pointer;
                font-size: 12px;
            }

            .card-row.hidden {
                display: none;
            }

            .card-row {
                display: flex;
                margin-bottom: 15px;
                padding-bottom: 15px;
                border-bottom: 1px solid #f0f0f0;
            }

            .card-label {
                min-width: 200px;
                color: #1e40af;
                font-size: 11px;
                text-transform: uppercase;
            }

            .card-value {
                flex: 1;
                color: #1a1a1a;
                word-break: break-word;
            }

            /* Remarks Section */
            .card-remarks {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #93c5fd;
            }

            .card-remarks-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .card-remarks-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                font-weight: 500;
            }

            .remarks-bubbles {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 20px;
            }

            .remark-bubble {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                background: #dbeafe;
                border: 1px solid #93c5fd;
                border-radius: 20px;
                font-size: 11px;
                color: #1e40af;
            }

            .remark-bubble-label {
                font-weight: 500;
                color: #1e3a8a;
            }

            .remark-bubble-value {
                color: #1a1a1a;
            }

            .no-remarks {
                color: #999;
                font-size: 12px;
                font-style: italic;
            }

            .add-remark-section {
                background: #f8fafc;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 15px;
            }

            .add-remark-row {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .add-remark-row select {
                min-width: 180px;
                flex: 0;
            }

            .add-remark-row input {
                flex: 1;
                min-width: 200px;
            }

            .quick-btns {
                display: flex;
                gap: 8px;
                margin-top: 10px;
                flex-wrap: wrap;
            }

            .quick-btn {
                padding: 5px 10px;
                font-size: 10px;
                background: #f0fdf4;
                border-color: #86efac;
                color: #166534;
            }

            .quick-btn:hover {
                background: #dcfce7;
            }

            /* Navigation */
            .card-navigation {
                display: flex;
                gap: 10px;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 1px solid #f0f0f0;
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 10px 20px;
                font-size: 12px;
            }

            .nav-btn.primary {
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .nav-btn.primary:hover {
                background: #1e3a8a;
            }

            .nav-btn.primary:disabled {
                background: #94a3b8;
                border-color: #94a3b8;
            }

            /* Custom Action Buttons */
            .custom-actions-section {
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #93c5fd;
            }

            .custom-actions-title {
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 15px;
            }

            .custom-actions-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            .custom-action-btn {
                background: #059669;
                color: #fff;
                border-color: #059669;
            }

            .custom-action-btn:hover {
                background: #047857;
                border-color: #047857;
                color: #fff;
            }

            .custom-action-btn.header-btn {
                background: #7c3aed;
                border-color: #7c3aed;
            }

            .custom-action-btn.header-btn:hover {
                background: #6d28d9;
                border-color: #6d28d9;
            }

            .message {
                padding: 12px;
                margin-bottom: 20px;
                background: #fff;
                border: 1px solid #e0e0e0;
                font-size: 11px;
                border-radius: 12px;
            }

            .message.success {
                border-color: #4caf50;
                color: #2e7d32;
                background: #e8f5e9;
            }

            .message.error {
                border-color: #f44336;
                color: #c62828;
                background: #ffebee;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #1e40af;
            }

            .select-all-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }

            .select-all-controls button {
                padding: 5px 10px;
                font-size: 10px;
            }

            .card-nav-header {
                padding: 10px 14px;
                background: #dbeafe;
                border-radius: 12px;
                margin-bottom: 10px;
                font-size: 10px;
                text-transform: uppercase;
                color: #1e40af;
                font-weight: 500;
                text-align: center;
            }

            /* Scripts */
            .scripts-list {
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                max-height: 200px;
                overflow-y: auto;
            }

            .script-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 12px;
                border-bottom: 1px solid #f0f0f0;
            }

            .script-item:last-child {
                border-bottom: none;
            }

            .script-item-name {
                font-weight: 500;
                color: #1e40af;
                font-size: 12px;
            }

            .script-item-actions {
                display: flex;
                gap: 6px;
            }

            .script-item-actions button {
                padding: 3px 8px;
                font-size: 10px;
            }

            .add-script-btn {
                margin-top: 10px;
                background: #1e40af;
                color: #fff;
                border-color: #1e40af;
            }

            .script-form-row {
                margin-bottom: 15px;
            }

            .script-form-row label {
                display: block;
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .script-form-row textarea {
                width: 100%;
                min-height: 150px;
                padding: 12px;
                font-family: "Roboto Mono", monospace;
                font-size: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                resize: vertical;
            }

            .script-form-row textarea:focus {
                outline: none;
                border-color: #1e40af;
            }

            .script-help {
                background: #f8fafc;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                padding: 12px;
                font-size: 10px;
                color: #666;
                margin-bottom: 15px;
            }

            .script-help code {
                background: #e2e8f0;
                padding: 1px 4px;
                border-radius: 3px;
            }

            .no-scripts {
                padding: 15px;
                text-align: center;
                color: #999;
                font-size: 11px;
            }

            /* Remark Column Management */
            .remark-column-item {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                margin-bottom: 8px;
            }

            .remark-column-item input {
                flex: 1;
                border-radius: 6px;
            }

            .remark-column-item button {
                padding: 5px 10px;
                font-size: 10px;
            }

            .add-column-row {
                display: flex;
                gap: 10px;
                margin-top: 10px;
            }

            .analytics-toggle-btn {
                background: #7c3aed;
                color: #fff;
                border-color: #7c3aed;
            }

            .analytics-toggle-btn:hover {
                background: #6d28d9;
                border-color: #6d28d9;
                color: #fff;
            }

            /* Remarks Edit Modal */
            .remark-edit-row {
                margin-bottom: 15px;
            }

            .remark-edit-row label {
                display: block;
                font-size: 11px;
                text-transform: uppercase;
                color: #1e40af;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .remark-edit-row input {
                width: 100%;
                border-radius: 8px;
            }

            .remark-quick-actions {
                display: flex;
                gap: 6px;
                margin-top: 6px;
            }

            .remark-quick-actions button {
                padding: 3px 8px;
                font-size: 9px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <div class="title">CSV VIEWER</div>
                <div class="header-controls">
                    <div class="view-toggle">
                        <button
                            class="toggle-btn active"
                            onclick="switchView('table')"
                        >
                            TABLE
                        </button>
                        <button class="toggle-btn" onclick="switchView('card')">
                            CARDS
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analytics Panel -->
            <div class="analytics-panel" id="analyticsPanel">
                <div class="analytics-header">
                    <div class="analytics-title">Analytics Dashboard</div>
                    <button onclick="toggleAnalytics()">CLOSE</button>
                </div>
                <div class="analytics-results" id="analyticsResults">
                    <div class="no-scripts">Run a script to see results</div>
                </div>
                <div
                    class="table-scripts-container"
                    id="tableScriptsContainer"
                ></div>
            </div>

            <div class="controls">
                <select id="columnFilter">
                    <option value="">FILTER COLUMN</option>
                </select>
                <select id="valueFilter" disabled>
                    <option value="">FILTER VALUE</option>
                </select>
                <input type="text" id="searchInput" placeholder="SEARCH..." />
                <button onclick="applyFilters()">APPLY</button>
                <button onclick="clearFilters()">CLEAR</button>
                <button
                    class="analytics-toggle-btn"
                    id="analyticsBtn"
                    onclick="toggleAnalytics()"
                >
                    ANALYTICS
                </button>
                <button onclick="openTableConfig()">TABLE CONFIG</button>
            </div>

            <div class="stats">
                <div class="stat">
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="totalRows">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Filtered</div>
                    <div class="stat-value" id="filteredRows">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">Current</div>
                    <div class="stat-value" id="currentIndex">-</div>
                </div>
            </div>

            <div id="messageArea"></div>

            <!-- Table View -->
            <div class="table-view" id="tableView">
                <div class="table-container" id="tableContainer">
                    <div class="loading">LOADING...</div>
                </div>
            </div>

            <!-- Card View -->
            <div class="card-view" id="cardView">
                <div class="card-container">
                    <div class="card-nav" id="cardNav"></div>
                    <div class="card-content" id="cardContent">
                        <div class="loading">SELECT A CARD</div>
                    </div>
                </div>
            </div>

            <!-- Table Config Modal -->
            <div class="modal" id="tableConfigModal">
                <div class="modal-content wide">
                    <div class="modal-header">TABLE CONFIGURATION</div>

                    <div class="config-section">
                        <div class="config-section-title">Visible Columns</div>
                        <div class="select-all-controls">
                            <button onclick="selectAllTableCols()">
                                SELECT ALL
                            </button>
                            <button onclick="deselectAllTableCols()">
                                DESELECT ALL
                            </button>
                        </div>
                        <div
                            class="field-toggles-container"
                            id="tableColToggles"
                        ></div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">
                            Table Scripts (Analytics)
                        </div>
                        <div class="script-help">
                            <code>count()</code> <code>sum(field)</code>
                            <code>average(field)</code>
                            <code>unique(field)</code>
                            <code>groupBy(field)</code>
                            <code>showResult(label, value)</code>
                            <code>exportCSV(data, filename)</code>
                        </div>
                        <div class="scripts-list" id="tableScriptsList"></div>
                        <button
                            class="add-script-btn"
                            onclick="openScriptEditor('table')"
                        >
                            + ADD SCRIPT
                        </button>
                    </div>

                    <div class="modal-footer">
                        <button class="primary" onclick="saveTableConfig()">
                            SAVE
                        </button>
                        <button onclick="closeTableConfig()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Card Config Modal -->
            <div class="modal" id="cardConfigModal">
                <div class="modal-content wide">
                    <div class="modal-header">CARD CONFIGURATION</div>

                    <div class="config-section">
                        <div class="config-section-title">
                            Sidebar Display Column
                        </div>
                        <select
                            id="sidebarDisplayColumn"
                            style="width: 100%; border-radius: 8px"
                        ></select>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Visible Fields</div>
                        <div class="select-all-controls">
                            <button onclick="selectAllCardFields()">
                                SELECT ALL
                            </button>
                            <button onclick="deselectAllCardFields()">
                                DESELECT ALL
                            </button>
                        </div>
                        <div
                            class="field-toggles-container"
                            id="cardFieldToggles"
                        ></div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Remark Columns</div>
                        <div id="remarkColumnsList"></div>
                        <div class="add-column-row">
                            <input
                                type="text"
                                id="newRemarkColumnName"
                                placeholder="New column name..."
                            />
                            <button onclick="addRemarkColumn()">ADD</button>
                        </div>
                    </div>

                    <div class="config-section">
                        <div class="config-section-title">Card Scripts</div>
                        <div class="script-help">
                            <code>getValue(field)</code>
                            <code>setRemark(col, val)</code>
                            <code>addToRemark(col, val)</code>
                            <code>dateToday()</code>
                            <code>openWindow(url)</code>
                            <code>copyToClipboard(text)</code>
                        </div>
                        <div class="scripts-list" id="cardScriptsList"></div>
                        <button
                            class="add-script-btn"
                            onclick="openScriptEditor('card')"
                        >
                            + ADD SCRIPT
                        </button>
                    </div>

                    <div class="modal-footer">
                        <button class="primary" onclick="saveCardConfig()">
                            SAVE
                        </button>
                        <button onclick="closeCardConfig()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Script Editor Modal -->
            <div class="modal" id="scriptEditorModal">
                <div class="modal-content wide">
                    <div class="modal-header" id="scriptEditorTitle">
                        ADD SCRIPT
                    </div>

                    <div class="script-form-row">
                        <label>Script Name</label>
                        <input
                            type="text"
                            id="scriptName"
                            placeholder="e.g., Search Google"
                        />
                    </div>

                    <div class="script-form-row">
                        <label>Button Label</label>
                        <input
                            type="text"
                            id="scriptBtnLabel"
                            placeholder="e.g., SEARCH"
                        />
                    </div>

                    <div class="script-form-row" id="scriptPositionRow">
                        <label>Position</label>
                        <select id="scriptPosition">
                            <option value="header">Header</option>
                            <option value="actions">Actions Section</option>
                            <option value="navigation">Navigation</option>
                        </select>
                    </div>

                    <div class="script-form-row">
                        <label>Code</label>
                        <textarea
                            id="scriptCode"
                            placeholder="// Your code here"
                        ></textarea>
                    </div>

                    <div class="modal-footer">
                        <button class="primary" onclick="saveScript()">
                            SAVE
                        </button>
                        <button onclick="closeScriptEditor()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Remarks Edit Modal -->
            <div class="modal" id="remarksModal">
                <div class="modal-content">
                    <div class="modal-header">EDIT REMARKS</div>
                    <div id="remarksEditContent"></div>
                    <div class="modal-footer">
                        <button class="primary" onclick="saveAllRemarks()">
                            SAVE ALL
                        </button>
                        <button onclick="closeRemarksModal()">CANCEL</button>
                    </div>
                </div>
            </div>

            <!-- Pending Windows Modal -->
            <div class="modal" id="pendingModal">
                <div class="modal-content">
                    <div class="modal-header">BLOCKED POPUPS</div>
                    <p
                        style="
                            margin-bottom: 15px;
                            font-size: 11px;
                            color: #666;
                        "
                    >
                        Your browser blocked some windows. Click to open:
                    </p>
                    <div id="pendingWindowsList"></div>
                    <div class="modal-footer">
                        <button class="primary" onclick="openAllPending()">
                            OPEN ALL
                        </button>
                        <button onclick="closePendingModal()">CLOSE</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // State
            let filteredData = [];
            let headers = [];
            let remarkColumns = [];
            let filterOptions = {};
            let currentView = "table";
            let currentCardIndex = -1;
            let sidebarVisible = true;
            let visibleCardFields = {};
            let visibleTableCols = {};
            let sidebarDisplayCol = "";
            let cardScripts = [];
            let tableScripts = [];
            let editingScriptIdx = -1;
            let editingScriptType = "card";
            let pendingWindows = [];
            let analyticsResults = {};

            // Storage
            const getHash = () => {
                let h = 0;
                for (let i = 0; i < location.pathname.length; i++) {
                    h = (h << 5) - h + location.pathname.charCodeAt(i);
                    h = h & h;
                }
                return Math.abs(h).toString(36);
            };

            const save = (k, v) =>
                localStorage.setItem(`${k}_${getHash()}`, JSON.stringify(v));
            const load = (k, d = {}) => {
                try {
                    return (
                        JSON.parse(localStorage.getItem(`${k}_${getHash()}`)) ||
                        d
                    );
                } catch {
                    return d;
                }
            };

            // Date helpers
            const dateToday = () => new Date().toISOString().split("T")[0];
            const dateNow = () =>
                new Date().toISOString().replace("T", " ").slice(0, 19);
            const timeNow = () => new Date().toTimeString().slice(0, 8);

            // Init
            async function init() {
                await loadHeaders();
                await loadFilterOptions();
                await loadData();

                visibleCardFields = load("cardFields", {});
                visibleTableCols = load("tableCols", {});
                sidebarDisplayCol = load("sidebarCol", "");
                cardScripts = load("cardScripts", []);
                tableScripts = load("tableScripts", []);
                sidebarVisible = load("sidebar", true);

                if (!Object.keys(visibleCardFields).length) {
                    [...headers, ...remarkColumns].forEach(
                        (h) => (visibleCardFields[h] = true),
                    );
                }
                if (!Object.keys(visibleTableCols).length) {
                    [...headers, ...remarkColumns].forEach(
                        (h) => (visibleTableCols[h] = true),
                    );
                }
                if (!sidebarDisplayCol && headers.length)
                    sidebarDisplayCol = headers[0];

                renderTableScripts();
            }

            async function loadHeaders() {
                try {
                    const res = await fetch("/api/headers");
                    const data = await res.json();
                    headers = data.headers;
                    remarkColumns = data.remark_columns || [];

                    const cf = document.getElementById("columnFilter");
                    cf.innerHTML = '<option value="">FILTER COLUMN</option>';
                    headers.forEach((h) => {
                        const o = document.createElement("option");
                        o.value = h;
                        o.textContent = h.toUpperCase();
                        cf.appendChild(o);
                    });

                    cf.onchange = () => {
                        const vf = document.getElementById("valueFilter");
                        vf.innerHTML = '<option value="">FILTER VALUE</option>';
                        if (cf.value) {
                            vf.disabled = false;
                            (filterOptions[cf.value] || []).forEach((v) => {
                                const o = document.createElement("option");
                                o.value = v;
                                o.textContent = v.toUpperCase();
                                vf.appendChild(o);
                            });
                        } else {
                            vf.disabled = true;
                        }
                    };
                } catch (e) {
                    showMessage("Error loading headers", "error");
                }
            }

            async function loadFilterOptions() {
                try {
                    const res = await fetch("/api/filter-options");
                    filterOptions = await res.json();
                } catch (e) {}
            }

            async function loadData() {
                try {
                    const params = new URLSearchParams();
                    const col = document.getElementById("columnFilter").value;
                    const val = document.getElementById("valueFilter").value;
                    const search = document.getElementById("searchInput").value;

                    if (col) params.append("column", col);
                    if (val) params.append("value", val);
                    if (search) params.append("search", search);

                    const res = await fetch("/api/data?" + params);
                    const data = await res.json();

                    filteredData = data.data || [];
                    remarkColumns = data.remark_columns || [];

                    document.getElementById("totalRows").textContent =
                        data.total || 0;
                    document.getElementById("filteredRows").textContent =
                        filteredData.length;

                    if (currentView === "table") renderTable();
                    else {
                        renderCardNav();
                        if (
                            currentCardIndex >= 0 &&
                            currentCardIndex < filteredData.length
                        )
                            showCard(currentCardIndex);
                    }
                } catch (e) {
                    showMessage("Error loading data", "error");
                }
            }

            // Table
            function renderTable() {
                const container = document.getElementById("tableContainer");
                const lastVisited = load("lastVisited", -1);

                if (!filteredData.length) {
                    container.innerHTML = '<div class="loading">NO DATA</div>';
                    return;
                }

                let html = "<table><thead><tr>";
                headers.forEach((h) => {
                    html += `<th class="${visibleTableCols[h] === false ? "hidden-column" : ""}">${h.toUpperCase()}</th>`;
                });
                remarkColumns.forEach((c) => {
                    html += `<th class="${visibleTableCols[c] === false ? "hidden-column" : ""}">${c.toUpperCase()}</th>`;
                });
                html += "<th>ACTIONS</th></tr></thead><tbody>";

                filteredData.forEach((row, idx) => {
                    const isLast = idx === lastVisited;
                    html += `<tr class="${isLast ? "last-visited" : ""}" id="row-${idx}">`;
                    headers.forEach((h) => {
                        html += `<td class="${visibleTableCols[h] === false ? "hidden-column" : ""}">${row[h] || ""}</td>`;
                    });
                    remarkColumns.forEach((c) => {
                        html += `<td class="${visibleTableCols[c] === false ? "hidden-column" : ""}">${row[c] || ""}</td>`;
                    });
                    html += `<td><button onclick="openCard(${idx})">VIEW</button></td></tr>`;
                });

                html += "</tbody></table>";
                container.innerHTML = html;

                if (lastVisited >= 0) {
                    const el = document.getElementById(`row-${lastVisited}`);
                    if (el)
                        setTimeout(
                            () =>
                                el.scrollIntoView({
                                    behavior: "smooth",
                                    block: "center",
                                }),
                            100,
                        );
                }
            }

            // Card
            function renderCardNav() {
                const nav = document.getElementById("cardNav");
                nav.innerHTML = `<div class="card-nav-header">Showing: ${sidebarDisplayCol || headers[0] || "Items"}</div>`;

                const col = sidebarDisplayCol || headers[0] || "";
                filteredData.forEach((row, idx) => {
                    const item = document.createElement("div");
                    item.className = `card-nav-item ${idx === currentCardIndex ? "active" : ""}`;
                    item.id = `nav-${idx}`;
                    item.textContent = `${idx + 1}. ${row[col] || "Row " + (idx + 1)}`;
                    item.onclick = () => showCard(idx);
                    nav.appendChild(item);
                });
            }

            function showCard(idx) {
                currentCardIndex = idx;
                save("lastVisited", idx);
                document.getElementById("currentIndex").textContent =
                    `${idx + 1} / ${filteredData.length}`;

                document.querySelectorAll(".card-nav-item").forEach((el, i) => {
                    el.classList.toggle("active", i === idx);
                });

                const el = document.getElementById(`nav-${idx}`);
                if (el)
                    el.scrollIntoView({ behavior: "smooth", block: "nearest" });

                const row = filteredData[idx];
                const content = document.getElementById("cardContent");
                const headerScripts = cardScripts.filter(
                    (s) => s.position === "header",
                );
                const actionScripts = cardScripts.filter(
                    (s) => s.position === "actions",
                );
                const navScripts = cardScripts.filter(
                    (s) => s.position === "navigation",
                );

                let html = '<div class="card">';

                // Header
                html += `<div class="card-header">
                    <div class="card-title">CARD ${idx + 1} OF ${filteredData.length}</div>
                    <div class="card-header-controls">
                        ${headerScripts.map((s) => `<button class="custom-action-btn header-btn" onclick="runCardScript(${cardScripts.indexOf(s)})">${s.label}</button>`).join("")}
                        <button class="toggle-sidebar-btn" onclick="toggleSidebar()">${sidebarVisible ? "HIDE" : "SHOW"} SIDEBAR</button>
                        <button class="config-btn" onclick="openCardConfig()">CONFIG</button>
                        <button class="close-card-btn" onclick="closeCard()">CLOSE</button>
                    </div>
                </div>`;

                // Fields
                headers.forEach((h) => {
                    if (visibleCardFields[h] !== false) {
                        html += `<div class="card-row"><div class="card-label">${h}</div><div class="card-value">${row[h] || "-"}</div></div>`;
                    }
                });

                // Actions
                if (actionScripts.length) {
                    html += `<div class="custom-actions-section"><div class="custom-actions-title">CUSTOM ACTIONS</div>
                        <div class="custom-actions-buttons">${actionScripts.map((s) => `<button class="custom-action-btn" onclick="runCardScript(${cardScripts.indexOf(s)})">${s.label}</button>`).join("")}</div></div>`;
                }

                // Remarks
                html += `<div class="card-remarks"><div class="card-remarks-header">
                    <span class="card-remarks-title">REMARKS</span>
                    <button onclick="openRemarksModal()">EDIT REMARKS</button>
                </div><div class="remarks-bubbles">`;

                let hasRemarks = false;
                remarkColumns.forEach((c) => {
                    const val = row[c];
                    if (val && val.trim()) {
                        hasRemarks = true;
                        html += `<span class="remark-bubble"><span class="remark-bubble-label">${c}:</span><span class="remark-bubble-value">${val}</span></span>`;
                    }
                });

                if (!hasRemarks)
                    html += '<span class="no-remarks">No remarks</span>';
                html += "</div>";

                // Add remark
                html += `<div class="add-remark-section"><div class="config-section-title">Quick Add</div>
                    <div class="add-remark-row">
                        <select id="addRemarkCol">${remarkColumns.map((c) => `<option value="${c}">${c}</option>`).join("")}</select>
                        <input type="text" id="addRemarkVal" placeholder="Enter value...">
                        <button onclick="quickAddRemark()">ADD</button>
                    </div>
                    <div class="quick-btns">
                        <button class="quick-btn" onclick="insertDate('today')">Today</button>
                        <button class="quick-btn" onclick="insertDate('now')">Date+Time</button>
                        <button class="quick-btn" onclick="insertDate('time')">Time</button>
                    </div>
                </div></div>`;

                // Navigation
                html += `<div class="card-navigation">
                    <button class="nav-btn primary" onclick="navCard(-1)" ${idx === 0 ? "disabled" : ""}>PREV</button>
                    <button class="nav-btn primary" onclick="navCard(1)" ${idx === filteredData.length - 1 ? "disabled" : ""}>NEXT</button>
                    ${navScripts.map((s) => `<button class="custom-action-btn" onclick="runCardScript(${cardScripts.indexOf(s)})">${s.label}</button>`).join("")}
                </div></div>`;

                content.innerHTML = html;
                applySidebarState();
            }

            function navCard(dir) {
                const newIdx = currentCardIndex + dir;
                if (newIdx >= 0 && newIdx < filteredData.length)
                    showCard(newIdx);
            }

            function openCard(idx) {
                currentCardIndex = idx;
                switchView("card");
                showCard(idx);
            }

            function closeCard() {
                switchView("table");
            }

            function toggleSidebar() {
                sidebarVisible = !sidebarVisible;
                save("sidebar", sidebarVisible);
                applySidebarState();
                const btn = document.querySelector(".toggle-sidebar-btn");
                if (btn)
                    btn.textContent = sidebarVisible
                        ? "HIDE SIDEBAR"
                        : "SHOW SIDEBAR";
            }

            function applySidebarState() {
                const nav = document.getElementById("cardNav");
                const content = document.getElementById("cardContent");
                nav.classList.toggle("hidden", !sidebarVisible);
                content.classList.toggle("full-width", !sidebarVisible);
            }

            // Remarks
            function openRemarksModal() {
                const row = filteredData[currentCardIndex];
                let html = "";

                remarkColumns.forEach((c, i) => {
                    html += `<div class="remark-edit-row">
                        <label>${c}</label>
                        <input type="text" id="remarkEdit${i}" value="${(row[c] || "").replace(/"/g, "&quot;")}">
                        <div class="remark-quick-actions">
                            <button onclick="appendToRemark(${i}, dateToday())">+Today</button>
                            <button onclick="appendToRemark(${i}, dateNow())">+DateTime</button>
                            <button onclick="document.getElementById('remarkEdit${i}').value=''">Clear</button>
                        </div>
                    </div>`;
                });

                document.getElementById("remarksEditContent").innerHTML = html;
                document.getElementById("remarksModal").classList.add("active");
            }

            function appendToRemark(idx, val) {
                const input = document.getElementById(`remarkEdit${idx}`);
                input.value = input.value ? `${input.value}, ${val}` : val;
            }

            async function saveAllRemarks() {
                const row = filteredData[currentCardIndex];

                for (let i = 0; i < remarkColumns.length; i++) {
                    const col = remarkColumns[i];
                    const val = document
                        .getElementById(`remarkEdit${i}`)
                        .value.trim();

                    await fetch(`/api/remarks/${row._index}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ column: col, value: val }),
                    });
                }

                closeRemarksModal();
                await loadData();
                showMessage("Remarks saved!", "success");
            }

            function closeRemarksModal() {
                document
                    .getElementById("remarksModal")
                    .classList.remove("active");
            }

            async function quickAddRemark() {
                const col = document.getElementById("addRemarkCol").value;
                const val = document
                    .getElementById("addRemarkVal")
                    .value.trim();
                if (!val) return showMessage("Enter a value", "error");

                const row = filteredData[currentCardIndex];
                const current = row[col] || "";
                const newVal = current ? `${current}, ${val}` : val;

                await fetch(`/api/remarks/${row._index}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ column: col, value: newVal }),
                });

                document.getElementById("addRemarkVal").value = "";
                await loadData();
                showMessage("Remark added!", "success");
            }

            function insertDate(type) {
                const input = document.getElementById("addRemarkVal");
                let val =
                    type === "today"
                        ? dateToday()
                        : type === "now"
                          ? dateNow()
                          : timeNow();
                input.value = input.value ? `${input.value} ${val}` : val;
            }

            // Remark column management
            async function addRemarkColumn() {
                const name = document
                    .getElementById("newRemarkColumnName")
                    .value.trim();
                if (!name) return showMessage("Enter column name", "error");

                const res = await fetch("/api/remark-columns", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "add", name }),
                });

                if (res.ok) {
                    document.getElementById("newRemarkColumnName").value = "";
                    await loadHeaders();
                    await loadData();
                    renderRemarkColumnsList();
                    showMessage("Column added!", "success");
                } else {
                    showMessage("Failed to add column", "error");
                }
            }

            async function renameRemarkColumn(oldName) {
                const input = document.getElementById(`renameCol_${oldName}`);
                const newName = input.value.trim();
                if (!newName || newName === oldName) return;

                const res = await fetch("/api/remark-columns", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "rename",
                        old_name: oldName,
                        new_name: newName,
                    }),
                });

                if (res.ok) {
                    await loadHeaders();
                    await loadData();
                    renderRemarkColumnsList();
                    showMessage("Column renamed!", "success");
                } else {
                    showMessage("Failed to rename", "error");
                }
            }

            async function deleteRemarkColumn(name) {
                if (!confirm(`Delete column "${name}"?`)) return;

                const res = await fetch("/api/remark-columns", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ action: "delete", name }),
                });

                if (res.ok) {
                    await loadHeaders();
                    await loadData();
                    renderRemarkColumnsList();
                    showMessage("Column deleted!", "success");
                } else {
                    showMessage("Failed to delete", "error");
                }
            }

            function renderRemarkColumnsList() {
                const container = document.getElementById("remarkColumnsList");
                if (!remarkColumns.length) {
                    container.innerHTML =
                        '<div class="no-scripts">No remark columns</div>';
                    return;
                }

                container.innerHTML = remarkColumns
                    .map(
                        (c) => `
                    <div class="remark-column-item">
                        <input type="text" id="renameCol_${c}" value="${c}">
                        <button onclick="renameRemarkColumn('${c}')">RENAME</button>
                        <button onclick="deleteRemarkColumn('${c}')">DELETE</button>
                    </div>
                `,
                    )
                    .join("");
            }

            // Analytics
            function toggleAnalytics() {
                document
                    .getElementById("analyticsPanel")
                    .classList.toggle("active");
            }

            function renderTableScripts() {
                const container = document.getElementById(
                    "tableScriptsContainer",
                );
                if (!tableScripts.length) {
                    container.innerHTML =
                        '<div class="no-scripts">No scripts. Add in TABLE CONFIG.</div>';
                    return;
                }
                container.innerHTML = tableScripts
                    .map(
                        (s, i) =>
                            `<button class="table-script-btn" onclick="runTableScript(${i})">${s.label}</button>`,
                    )
                    .join("");
            }

            // Table Script helpers
            const getAllData = () => filteredData;
            const getColumn = (f) =>
                filteredData.map((r) => r[f]).filter((v) => v);
            const count = () => filteredData.length;
            const countWhere = (f, v) =>
                filteredData.filter((r) => r[f] === v).length;
            const sum = (f) =>
                getColumn(f).reduce((a, v) => a + (parseFloat(v) || 0), 0);
            const average = (f) => {
                const vals = getColumn(f)
                    .map((v) => parseFloat(v))
                    .filter((v) => !isNaN(v));
                return vals.length
                    ? vals.reduce((a, b) => a + b, 0) / vals.length
                    : 0;
            };
            const unique = (f) => [...new Set(getColumn(f))];
            const groupBy = (f) => {
                const g = {};
                filteredData.forEach((r) => {
                    const k = r[f] || "N/A";
                    g[k] = (g[k] || 0) + 1;
                });
                return g;
            };
            const filterData = (f, v) => filteredData.filter((r) => r[f] === v);
            const showResult = (l, v) => {
                analyticsResults[l] = v;
                renderAnalyticsResults();
            };
            const clearResults = () => {
                analyticsResults = {};
                renderAnalyticsResults();
            };
            const exportCSV = (data, fn) => {
                if (!data.length) return showMessage("No data", "error");
                const h = Object.keys(data[0]).filter(
                    (k) => !k.startsWith("_"),
                );
                let csv = h.join(",") + "\n";
                data.forEach((r) => {
                    csv +=
                        h
                            .map((k) => {
                                let v = r[k] || "";
                                if (String(v).includes(",")) v = `"${v}"`;
                                return v;
                            })
                            .join(",") + "\n";
                });
                const blob = new Blob([csv], { type: "text/csv" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = fn || "export.csv";
                a.click();
                showMessage("Exported!", "success");
            };

            function renderAnalyticsResults() {
                const container = document.getElementById("analyticsResults");
                const entries = Object.entries(analyticsResults);
                if (!entries.length) {
                    container.innerHTML =
                        '<div class="no-scripts">Run a script to see results</div>';
                    return;
                }
                container.innerHTML = entries
                    .map(
                        ([l, v]) => `
                    <div class="analytics-result-card">
                        <div class="analytics-result-label">${l}</div>
                        <div class="analytics-result-value">${typeof v === "object" ? JSON.stringify(v) : v}</div>
                    </div>
                `,
                    )
                    .join("");
            }

            function runTableScript(idx) {
                const s = tableScripts[idx];
                try {
                    new Function(
                        "getAllData",
                        "getColumn",
                        "count",
                        "countWhere",
                        "sum",
                        "average",
                        "unique",
                        "groupBy",
                        "filterData",
                        "showResult",
                        "clearResults",
                        "exportCSV",
                        "headers",
                        "remarkColumns",
                        "dateToday",
                        "dateNow",
                        "showAlert",
                        "copyToClipboard",
                        s.code,
                    )(
                        getAllData,
                        getColumn,
                        count,
                        countWhere,
                        sum,
                        average,
                        unique,
                        groupBy,
                        filterData,
                        showResult,
                        clearResults,
                        exportCSV,
                        headers,
                        remarkColumns,
                        dateToday,
                        dateNow,
                        showAlert,
                        copyToClipboard,
                    );
                } catch (e) {
                    showMessage("Script error: " + e.message, "error");
                }
            }

            // Card Script helpers
            const getValue = (f) => filteredData[currentCardIndex]?.[f] || "";
            const setRemark = async (c, v) => {
                await fetch(
                    `/api/remarks/${filteredData[currentCardIndex]._index}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ column: c, value: v }),
                    },
                );
                await loadData();
                showMessage("Saved!", "success");
            };
            const addToRemark = async (c, v) => {
                const cur = getValue(c);
                await setRemark(c, cur ? `${cur}, ${v}` : v);
            };
            const openWindow = (url) => {
                const w = window.open(url, "_blank");
                if (!w) {
                    pendingWindows.push(url);
                    showPendingModal();
                }
            };
            const openWindows = (urls) => {
                pendingWindows = [];
                urls.forEach((u, i) =>
                    setTimeout(() => {
                        const w = window.open(u, "_blank");
                        if (!w) pendingWindows.push(u);
                        if (i === urls.length - 1 && pendingWindows.length)
                            showPendingModal();
                    }, i * 100),
                );
            };
            const googleSearch = (q) =>
                "https://google.com/search?q=" + encodeURIComponent(q);
            const showAlert = (m) => showMessage(m, "success");
            const copyToClipboard = (t) => {
                navigator.clipboard
                    .writeText(String(t))
                    .then(() => showMessage("Copied!", "success"));
            };

            function runCardScript(idx) {
                const s = cardScripts[idx];
                try {
                    new Function(
                        "getValue",
                        "setRemark",
                        "addToRemark",
                        "openWindow",
                        "openWindows",
                        "googleSearch",
                        "showAlert",
                        "copyToClipboard",
                        "dateToday",
                        "dateNow",
                        "timeNow",
                        "headers",
                        "remarkColumns",
                        "data",
                        "index",
                        s.code,
                    )(
                        getValue,
                        setRemark,
                        addToRemark,
                        openWindow,
                        openWindows,
                        googleSearch,
                        showAlert,
                        copyToClipboard,
                        dateToday,
                        dateNow,
                        timeNow,
                        headers,
                        remarkColumns,
                        filteredData[currentCardIndex],
                        currentCardIndex,
                    );
                } catch (e) {
                    showMessage("Script error: " + e.message, "error");
                }
            }

            // Config Modals
            function openTableConfig() {
                const container = document.getElementById("tableColToggles");
                container.innerHTML = "";
                [...headers, ...remarkColumns].forEach((h) => {
                    const div = document.createElement("div");
                    div.className = "field-toggle";
                    div.innerHTML = `<input type="checkbox" id="tcol_${h}" ${visibleTableCols[h] !== false ? "checked" : ""}><label for="tcol_${h}">${h}</label>`;
                    div.onclick = (e) => {
                        if (e.target.tagName !== "INPUT")
                            div.querySelector("input").checked =
                                !div.querySelector("input").checked;
                    };
                    container.appendChild(div);
                });

                renderTableScriptsList();
                document
                    .getElementById("tableConfigModal")
                    .classList.add("active");
            }

            function closeTableConfig() {
                document
                    .getElementById("tableConfigModal")
                    .classList.remove("active");
            }

            function saveTableConfig() {
                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`tcol_${h}`);
                    if (cb) visibleTableCols[h] = cb.checked;
                });
                save("tableCols", visibleTableCols);
                closeTableConfig();
                renderTable();
                showMessage("Saved!", "success");
            }

            function selectAllTableCols() {
                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`tcol_${h}`);
                    if (cb) cb.checked = true;
                });
            }

            function deselectAllTableCols() {
                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`tcol_${h}`);
                    if (cb) cb.checked = false;
                });
            }

            function renderTableScriptsList() {
                const container = document.getElementById("tableScriptsList");
                if (!tableScripts.length) {
                    container.innerHTML =
                        '<div class="no-scripts">No scripts</div>';
                    return;
                }
                container.innerHTML = tableScripts
                    .map(
                        (s, i) => `
                    <div class="script-item">
                        <span class="script-item-name">${s.name}</span>
                        <div class="script-item-actions">
                            <button onclick="editScript('table', ${i})">EDIT</button>
                            <button onclick="deleteScript('table', ${i})">DEL</button>
                        </div>
                    </div>
                `,
                    )
                    .join("");
            }

            function openCardConfig() {
                const sel = document.getElementById("sidebarDisplayColumn");
                sel.innerHTML = headers
                    .map(
                        (h) =>
                            `<option value="${h}" ${h === sidebarDisplayCol ? "selected" : ""}>${h}</option>`,
                    )
                    .join("");

                const container = document.getElementById("cardFieldToggles");
                container.innerHTML = "";
                [...headers, ...remarkColumns].forEach((h) => {
                    const div = document.createElement("div");
                    div.className = "field-toggle";
                    div.innerHTML = `<input type="checkbox" id="cfield_${h}" ${visibleCardFields[h] !== false ? "checked" : ""}><label for="cfield_${h}">${h}</label>`;
                    div.onclick = (e) => {
                        if (e.target.tagName !== "INPUT")
                            div.querySelector("input").checked =
                                !div.querySelector("input").checked;
                    };
                    container.appendChild(div);
                });

                renderRemarkColumnsList();
                renderCardScriptsList();
                document
                    .getElementById("cardConfigModal")
                    .classList.add("active");
            }

            function closeCardConfig() {
                document
                    .getElementById("cardConfigModal")
                    .classList.remove("active");
            }

            function saveCardConfig() {
                sidebarDisplayCol = document.getElementById(
                    "sidebarDisplayColumn",
                ).value;
                save("sidebarCol", sidebarDisplayCol);

                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`cfield_${h}`);
                    if (cb) visibleCardFields[h] = cb.checked;
                });
                save("cardFields", visibleCardFields);

                closeCardConfig();
                renderCardNav();
                if (currentCardIndex >= 0) showCard(currentCardIndex);
                showMessage("Saved!", "success");
            }

            function selectAllCardFields() {
                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`cfield_${h}`);
                    if (cb) cb.checked = true;
                });
            }

            function deselectAllCardFields() {
                [...headers, ...remarkColumns].forEach((h) => {
                    const cb = document.getElementById(`cfield_${h}`);
                    if (cb) cb.checked = false;
                });
            }

            function renderCardScriptsList() {
                const container = document.getElementById("cardScriptsList");
                if (!cardScripts.length) {
                    container.innerHTML =
                        '<div class="no-scripts">No scripts</div>';
                    return;
                }
                container.innerHTML = cardScripts
                    .map(
                        (s, i) => `
                    <div class="script-item">
                        <span class="script-item-name">${s.name}</span>
                        <div class="script-item-actions">
                            <button onclick="editScript('card', ${i})">EDIT</button>
                            <button onclick="deleteScript('card', ${i})">DEL</button>
                        </div>
                    </div>
                `,
                    )
                    .join("");
            }

            // Script Editor
            function openScriptEditor(type, idx = -1) {
                editingScriptType = type;
                editingScriptIdx = idx;

                document.getElementById("scriptPositionRow").style.display =
                    type === "card" ? "block" : "none";
                document.getElementById("scriptEditorTitle").textContent =
                    idx >= 0 ? "EDIT SCRIPT" : "ADD SCRIPT";

                if (idx >= 0) {
                    const s =
                        type === "card" ? cardScripts[idx] : tableScripts[idx];
                    document.getElementById("scriptName").value = s.name;
                    document.getElementById("scriptBtnLabel").value = s.label;
                    document.getElementById("scriptPosition").value =
                        s.position || "actions";
                    document.getElementById("scriptCode").value = s.code;
                } else {
                    document.getElementById("scriptName").value = "";
                    document.getElementById("scriptBtnLabel").value = "";
                    document.getElementById("scriptPosition").value = "actions";
                    document.getElementById("scriptCode").value = "";
                }

                document
                    .getElementById("scriptEditorModal")
                    .classList.add("active");
            }

            function closeScriptEditor() {
                document
                    .getElementById("scriptEditorModal")
                    .classList.remove("active");
            }

            function saveScript() {
                const name = document.getElementById("scriptName").value.trim();
                const label = document
                    .getElementById("scriptBtnLabel")
                    .value.trim();
                const position =
                    document.getElementById("scriptPosition").value;
                const code = document.getElementById("scriptCode").value.trim();

                if (!name || !label || !code)
                    return showMessage("Fill all fields", "error");

                const script = { name, label, code };
                if (editingScriptType === "card") script.position = position;

                const scripts =
                    editingScriptType === "card" ? cardScripts : tableScripts;
                if (editingScriptIdx >= 0) scripts[editingScriptIdx] = script;
                else scripts.push(script);

                save(
                    editingScriptType === "card"
                        ? "cardScripts"
                        : "tableScripts",
                    scripts,
                );

                if (editingScriptType === "card") renderCardScriptsList();
                else {
                    renderTableScriptsList();
                    renderTableScripts();
                }

                closeScriptEditor();
                showMessage("Script saved!", "success");
            }

            function editScript(type, idx) {
                openScriptEditor(type, idx);
            }

            function deleteScript(type, idx) {
                if (!confirm("Delete script?")) return;

                const scripts = type === "card" ? cardScripts : tableScripts;
                scripts.splice(idx, 1);
                save(type === "card" ? "cardScripts" : "tableScripts", scripts);

                if (type === "card") renderCardScriptsList();
                else {
                    renderTableScriptsList();
                    renderTableScripts();
                }

                showMessage("Deleted!", "success");
            }

            // Pending Windows
            function showPendingModal() {
                document.getElementById("pendingWindowsList").innerHTML =
                    pendingWindows
                        .map(
                            (u, i) => `
                    <div style="margin-bottom:8px;display:flex;gap:10px;align-items:center;">
                        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;font-size:11px;">${u}</span>
                        <button onclick="window.open('${u}','_blank')">OPEN</button>
                    </div>
                `,
                        )
                        .join("");
                document.getElementById("pendingModal").classList.add("active");
            }

            function openAllPending() {
                pendingWindows.forEach((u, i) =>
                    setTimeout(() => window.open(u, "_blank"), i * 300),
                );
                closePendingModal();
            }

            function closePendingModal() {
                document
                    .getElementById("pendingModal")
                    .classList.remove("active");
                pendingWindows = [];
            }

            // View Switch
            function switchView(view) {
                currentView = view;
                document
                    .querySelectorAll(".toggle-btn")
                    .forEach((b, i) =>
                        b.classList.toggle(
                            "active",
                            (view === "table" && i === 0) ||
                                (view === "card" && i === 1),
                        ),
                    );

                if (view === "table") {
                    document
                        .getElementById("tableView")
                        .classList.remove("hidden");
                    document
                        .getElementById("cardView")
                        .classList.remove("active");
                    document.getElementById("analyticsBtn").style.display = "";
                    document.getElementById("currentIndex").textContent = "-";
                    renderTable();
                } else {
                    document
                        .getElementById("tableView")
                        .classList.add("hidden");
                    document.getElementById("cardView").classList.add("active");
                    document.getElementById("analyticsBtn").style.display =
                        "none";
                    document
                        .getElementById("analyticsPanel")
                        .classList.remove("active");
                    renderCardNav();

                    const last = load("lastVisited", -1);
                    if (last >= 0 && last < filteredData.length) showCard(last);
                    else if (
                        currentCardIndex >= 0 &&
                        currentCardIndex < filteredData.length
                    )
                        showCard(currentCardIndex);
                    else if (filteredData.length) showCard(0);
                }
            }

            // Filters
            function applyFilters() {
                currentCardIndex = -1;
                loadData();
            }

            function clearFilters() {
                document.getElementById("columnFilter").value = "";
                document.getElementById("valueFilter").value = "";
                document.getElementById("valueFilter").disabled = true;
                document.getElementById("searchInput").value = "";
                currentCardIndex = -1;
                loadData();
            }

            // Messages
            function showMessage(msg, type) {
                const area = document.getElementById("messageArea");
                area.innerHTML = `<div class="message ${type}">${msg}</div>`;
                setTimeout(() => (area.innerHTML = ""), 3000);
            }

            // Keyboard
            document.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                    const modals = [
                        "remarksModal",
                        "scriptEditorModal",
                        "cardConfigModal",
                        "tableConfigModal",
                        "pendingModal",
                    ];
                    for (const id of modals) {
                        const m = document.getElementById(id);
                        if (m.classList.contains("active")) {
                            m.classList.remove("active");
                            return;
                        }
                    }
                    if (currentView === "card") closeCard();
                }

                if (
                    currentView === "card" &&
                    !document.querySelector(".modal.active")
                ) {
                    if (e.key === "ArrowLeft" && currentCardIndex > 0)
                        navCard(-1);
                    else if (
                        e.key === "ArrowRight" &&
                        currentCardIndex < filteredData.length - 1
                    )
                        navCard(1);
                }
            });

            document
                .getElementById("searchInput")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") applyFilters();
                });

            // Init
            init();
        </script>
    </body>
</html>
